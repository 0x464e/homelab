- hosts: traefik
  tasks:
    - name: Update and upgrade apt packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: yes

    - name: Ensure dependencies
      ansible.builtin.apt:
        name:
          - tar
          - git
          - openssh-client
          - python3-minimal
          - python3-pip
        state: present

    - name: Create directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ traefik_folder }}/log"
        - "{{ traefik_folder }}/ssh"
        - "{{ tos_folder }}"

    - name: Generate SSH keypair for Traefik → Docker
      community.crypto.openssh_keypair:
        path: "{{ traefik_folder }}/ssh/id_ed25519"
        type: ed25519
        mode: "0600"
        comment: "traefik@{{ inventory_hostname }}"
      register: traefik_sshkey

    - name: Create SSH config entry for Docker VM
      ansible.builtin.copy:
        dest: /etc/ssh/ssh_config.d/traefik-docker.conf
        mode: "0644"
        content: |
          Host docker-vm
            HostName {{ hostvars['docker-vm']['ansible_host'] }}
            User {{ hostvars['docker-vm']['ansible_user'] }}
            IdentityFile {{ traefik_folder }}/ssh/id_ed25519
            IdentitiesOnly yes
            StrictHostKeyChecking no

    - name: Authorize Traefik public key on Docker VM user
      ansible.builtin.authorized_key:
        user: "{{ hostvars['docker-vm']['ansible_user'] }}"
        key: "{{ traefik_sshkey.public_key }}"
        state: present
      delegate_to: docker-vm

    - name: Render static config
      ansible.builtin.template:
        src: "../traefik/traefik.yml.j2"
        dest: "{{ traefik_folder }}/traefik.yml"
      notify: Restart traefik

    - name: Render dynamic configs
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "{{ traefik_folder }}/conf.d/{{ item | basename | replace('.j2', '') }}"
      with_fileglob:
        - "../traefik/conf.d/*.j2"

    - name: Ensure acme.json exists and locked down
      ansible.builtin.file:
        path: "{{ traefik_folder }}/acme.json"
        state: touch
        mode: "0600"
        modification_time: preserve
        access_time: preserve

    - name: Check if Traefik binary exists
      ansible.builtin.stat:
        path: "{{ traefik_bin_path }}"
      register: traefik_bin

    - name: Get current Traefik version
      ansible.builtin.command: "{{ traefik_bin_path }} version"
      changed_when: false
      failed_when: false
      when: traefik_bin.stat.exists
      register: installed_traefik_version_cmd

    - name: Parse current Traefik version
      ansible.builtin.set_fact:
        current_traefik_version: >-
          {{
            installed_traefik_version_cmd.stdout
            | regex_search('Version:\s*([0-9.]+)', '\1')
            | default(['0.0.0'], true)
            | first
          }}
      when: traefik_bin.stat.exists and installed_traefik_version_cmd.stdout is defined

    - name: Set default version if not installed
      ansible.builtin.set_fact:
        current_traefik_version: "0.0.0"
      when: not traefik_bin.stat.exists

    - name: Get latest Traefik release info
      ansible.builtin.uri:
        url: "https://api.github.com/repos/{{ traefik_repo }}/releases/latest"
        return_content: yes
      register: latest_traefik_release

    - name: Parse latest Traefik version
      ansible.builtin.set_fact:
        latest_traefik_version: "{{ latest_traefik_release.json.tag_name | trim('v') }}"

    - name: Detemine if Traefik install or upgrade is needed
      ansible.builtin.set_fact:
        traefik_install_needed: "{{ current_traefik_version is version(latest_traefik_version, '<', 'semver') }}"

    - name: Get download URL for latest Traefik binary
      ansible.builtin.set_fact:
        latest_traefik_download_url: >-
          {{
            latest_traefik_release.json.assets
            | selectattr('name', 'search', 'linux_amd64.tar.gz')
            | map(attribute='browser_download_url')
            | first
          }}
      when: traefik_install_needed

    - name: Download and extract latest Traefik binary
      ansible.builtin.unarchive:
        src: "{{ latest_traefik_download_url }}"
        include: [ "traefik" ]
        dest: /usr/bin
        remote_src: yes
      when: traefik_install_needed
      notify: Restart traefik

    - name: Create systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/traefik.service
        content: |
          [Unit]
          Description=Traefik: The Cloud Native Edge Router
          ConditionFileIsExecutable={{ traefik_bin_path }}
          After=syslog.target network-online.target

          [Service]
          Type=notify
          StartLimitInterval=5
          StartLimitBurst=10
          ExecStart={{ traefik_bin_path }}
          StandardOutput=append:{{ traefik_folder }}/log/traefik.out
          StandardError=append:{{ traefik_folder }}/log/traefik.err
          Restart=always
          RestartSec=10
          ExecReload=/bin/kill -USR1 $MAINPID
          Environment="CF_DNS_API_TOKEN={{ cloudflare_dns_api_token }}"

          [Install]
          WantedBy=multi-user.target
      register: traefik_service_config

    - name: Reload systemd if traefik service file changed
      ansible.builtin.systemd:
        daemon_reload: yes
      when: traefik_service_config.changed

    - name: Start and enable Traefik service
      ansible.builtin.systemd:
        name: traefik
        enabled: yes
        state: started

    - name: pip exrex
      ansible.builtin.pip:
        name: exrex
        version: 0.12.0
        break_system_packages: true

    - name: Check if traefik-opnsense-sync exists
      ansible.builtin.stat:
        path: "{{ tos_bin_path }}"
      register: tos_bin

    - name: Get current traefik-opnsense-sync version
      ansible.builtin.command: "{{ tos_bin_path }} --version"
      changed_when: false
      failed_when: false
      when: tos_bin.stat.exists
      register: installed_tos_version_cmd

    - name: Parse current traefik-opnsense-sync version
      ansible.builtin.set_fact:
        current_tos_version: >-
          {{ 
            installed_tos_version_cmd.stdout 
            | regex_search('version:\s*([0-9.]+)', '\1') 
            | default(['0.0.0'], true)
            | first
          }}
      when: tos_bin.stat.exists and installed_tos_version_cmd.stdout is defined

    - name: Set default version if not installed
      ansible.builtin.set_fact:
        current_tos_version: "0.0.0"
      when: not tos_bin.stat.exists

    - name: Get latest traefik-opnsense-sync release info
      ansible.builtin.uri:
        url: "https://api.github.com/repos/{{ tos_repo }}/releases/latest"
        return_content: yes
      register: latest_tos_release

    - name: Parse latest traefik-opnsense-sync version
      ansible.builtin.set_fact:
        latest_tos_version: "{{ latest_tos_release.json.tag_name | trim('v') }}"

    - name: Detemine if traefik-opnsense-sync install or upgrade is needed
      ansible.builtin.set_fact:
        tos_install_needed: "{{ current_tos_version is version(latest_tos_version, '<', 'semver') }}"

    - name: Get download URL for latest traefik-opnsense-sync binary
      ansible.builtin.set_fact:
        latest_tos_download_url: >-
          {{
            latest_tos_release.json.assets
            | selectattr('name', 'equalto', 'traefik-opnsense-sync_Linux_x86_64.tar.gz')
            | map(attribute='browser_download_url')
            | first
          }}
      when: tos_install_needed

    - name: Download and extract latest traefik-opnsense-sync binary
      ansible.builtin.unarchive:
        src: "{{ latest_tos_download_url }}"
        include: [ "traefik-opnsense-sync" ]
        dest: /usr/bin
        remote_src: yes
      when: tos_install_needed
      notify: Restart traefik-opnsense-sync

    - name: Render traefik-opnsense-sync config
      ansible.builtin.template:
        src: "../traefik/traefik-opnsense-sync.yml.j2"
        dest: "{{ tos_folder }}/config.yml"
      notify: Restart traefik-opnsense-sync

    - name: Create systemd service for traefik-opnsense-sync
      ansible.builtin.copy:
        dest: /etc/systemd/system/traefik-opnsense-sync.service
        content: |
          [Unit]
          Description=Traefik ↔ OPNsense Sync Service
          ConditionFileIsExecutable={{ tos_bin_path }}
          After=syslog.target network-online.target
          
          [Service]
          WorkingDirectory={{ tos_folder }}
          ExecStart={{ tos_bin_path }}
          StandardOutput=append:{{ tos_folder }}/traefik-opnsense-sync.out
          StandardError=append:{{ tos_folder }}/traefik-opnsense-sync.err
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
      register: tos_service_config

    - name: Reload systemd if traefik-opnsense-sync service file changed
      ansible.builtin.systemd:
        daemon_reload: yes
      when: tos_service_config.changed

    - name: Start and enable traefik-opnsense-sync service
      ansible.builtin.systemd:
        name: traefik-opnsense-sync
        enabled: yes
        state: started


  handlers:
    - name: Restart traefik
      ansible.builtin.systemd:
        name: traefik
        state: restarted

    - name: Restart traefik-opnsense-sync
      ansible.builtin.systemd:
        name: traefik-opnsense-sync
        state: restarted
